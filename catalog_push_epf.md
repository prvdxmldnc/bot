# Внешняя обработка УТ 10.3: выгрузка каталога в Telegram-bot backend (FastAPI)

Ниже приведён полный исходный код **модуля обработки** и **модуля формы** для внешней обработки (.epf) под:

- 1С:Предприятие 8.3.15.1656
- Конфигурация: Управление торговлей 10.3.40.1
- Режим: внешняя обработка без доработки конфигурации

Код ориентирован на запуск через **Файл → Открыть** в режиме **Предприятие**. Все параметры можно ввести через диалоги; форма используется только для кнопки «Выгрузить» (не обязателен сложный интерфейс).

---

## Модуль обработки (Общий модуль обработки / Модуль объекта обработки)

> Скопируйте целиком в модуль обработки внешней обработки.

```bsl
// === МОДУЛЬ ОБРАБОТКИ ===

Перем АдресСервера;
Перем ПутьAPI;
Перем ТокенДоступа;
Перем НаименованиеТипаЦен;
Перем ДатаВыгрузки;
Перем ВестиЛог;

// Главная точка входа (можно вызвать из формы)
Процедура ВыгрузитьКаталог() Экспорт
	
	Если НЕ ЗапроситьПараметрыВыгрузки() Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		КаталогJSON = СформироватьJSONКаталога();
	Исключение
		Сообщить("Ошибка формирования данных: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Попытка
		Ответ = ОтправитьHTTP(КаталогJSON);
		Сообщить("HTTP ответ: " + Ответ);
	Исключение
		Сообщить("Ошибка HTTP: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры


// --- Ввод параметров ---
Функция ЗапроситьПараметрыВыгрузки() Экспорт
	
	// Адрес сервера (без хвоста пути)
	Если НЕ ВвестиСтроку(АдресСервера, "Введите адрес сервера (например https://example.com)", 100) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ПустаяСтрока(АдресСервера) Тогда
		Сообщить("Адрес сервера не задан.");
		Возврат Ложь;
	КонецЕсли;
	
	// Путь API
	Если НЕ ВвестиСтроку(ПутьAPI, "Введите путь API (например /integrations/1c/catalog)", 200) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ПустаяСтрока(ПутьAPI) Тогда
		Сообщить("Путь API не задан.");
		Возврат Ложь;
	КонецЕсли;
	
	// Токен (опционально)
	Если НЕ ВвестиСтроку(ТокенДоступа, "Токен (опционально, можно оставить пустым)", 200) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Наименование типа цен
	Если НЕ ВвестиСтроку(НаименованиеТипаЦен, "Введите наименование типа цен (например Розничная)", 100) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ПустаяСтрока(НаименованиеТипаЦен) Тогда
		Сообщить("Тип цен не задан.");
		Возврат Ложь;
	КонецЕсли;
	
	// Дата выгрузки (текущая дата по умолчанию)
	Если ДатаВыгрузки = Неопределено Тогда
		ДатаВыгрузки = ТекущаяДата();
	КонецЕсли;
	
	Если НЕ ВвестиСтроку(ДатаВыгрузки, "Дата выгрузки (по умолчанию текущая)", 20) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Логирование
	ВестиЛог = Вопрос("Вести лог в файл рядом с .epf?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да;
	
	Возврат Истина;
	
КонецФункции


// --- Формирование JSON ---
Функция СформироватьJSONКаталога() Экспорт
	
	ТипЦен = НайтиТипЦенПоНаименованию(НаименованиеТипаЦен);
	Если ТипЦен = Неопределено Тогда
		ВызватьИсключение "Тип цен не найден: " + НаименованиеТипаЦен;
	КонецЕсли;
	
	Цены = ПолучитьЦеныНоменклатуры(ТипЦен, ДатаВыгрузки);
	Остатки = ПолучитьОстаткиНоменклатуры(ДатаВыгрузки);
	
	// Формируем массив товаров
	МассивТоваров = Новый Массив;
	
	ВыборкаНоменклатуры = Справочники.Номенклатура.Выбрать();
	Пока ВыборкаНоменклатуры.Следующий() Цикл
		
		Если ВыборкаНоменклатуры.ЭтоГруппа Тогда
			Продолжить;
		КонецЕсли;
		
		Товар = Новый Структура;
		Артикул = ВыборкаНоменклатуры.Артикул;
		Если ПустаяСтрока(Артикул) Тогда
			Артикул = Строка(ВыборкаНоменклатуры.Ссылка);
		КонецЕсли;
		
		Товар.Вставить("sku", Артикул);
		Товар.Вставить("title", ВыборкаНоменклатуры.Наименование);
		
		Если ЗначениеЗаполнено(ВыборкаНоменклатуры.Родитель) Тогда
			Товар.Вставить("category", ВыборкаНоменклатуры.Родитель.Наименование);
		Иначе
			Товар.Вставить("category", "");
		КонецЕсли;
		
		Цена = 0;
		Если Цены.Свойство(ВыборкаНоменклатуры.Ссылка) Тогда
			Цена = Цены[ВыборкаНоменклатуры.Ссылка];
		КонецЕсли;
		Товар.Вставить("price", Цена);
		
		Остаток = 0;
		Если Остатки.Свойство(ВыборкаНоменклатуры.Ссылка) Тогда
			Остаток = Остатки[ВыборкаНоменклатуры.Ссылка];
		КонецЕсли;
		Товар.Вставить("stock_qty", Остаток);
		
		Товар.Вставить("description", "");
		
		МассивТоваров.Добавить(Товар);
		
	КонецЦикла;
	
	КореньJSON = Новый Структура;
	КореньJSON.Вставить("items", МассивТоваров);
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, КореньJSON);
	
	Возврат ЗаписьJSON.Закрыть();
	
КонецФункции


// --- Поиск типа цен ---
Функция НайтиТипЦенПоНаименованию(ИмяТипа) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТипыЦен.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ТипыЦенНоменклатуры КАК ТипыЦен
	|ГДЕ
	|	ТипыЦен.Наименование = &Имя";
	Запрос.УстановитьПараметр("Имя", ИмяТипа);
	
	Результат = Запрос.Выполнить().Выбрать();
	Если Результат.Следующий() Тогда
		Возврат Результат.Ссылка;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции


// --- Цены ---
Функция ПолучитьЦеныНоменклатуры(ТипЦен, ДатаСреза) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Цены.Номенклатура КАК Номенклатура,
	|	Цены.Цена КАК Цена
	|ИЗ
	|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ДатаСреза, ТипЦен = &ТипЦен) КАК Цены";
	Запрос.УстановитьПараметр("ДатаСреза", ДатаСреза);
	Запрос.УстановитьПараметр("ТипЦен", ТипЦен);
	
	Таблица = Запрос.Выполнить().Выгрузить();
	ЦеныПоНоменклатуре = Новый Соответствие;
	
	Для Каждого СтрокаТаблицы Из Таблица Цикл
		ЦеныПоНоменклатуре.Вставить(СтрокаТаблицы.Номенклатура, СтрокаТаблицы.Цена);
	КонецЦикла;
	
	Возврат ЦеныПоНоменклатуре;
	
КонецФункции


// --- Остатки ---
Функция ПолучитьОстаткиНоменклатуры(ДатаСреза) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Остатки.Номенклатура КАК Номенклатура,
	|	СУММА(Остатки.КоличествоОстаток) КАК Остаток
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(&ДатаСреза) КАК Остатки
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Номенклатура";
	Запрос.УстановитьПараметр("ДатаСреза", ДатаСреза);
	
	Таблица = Запрос.Выполнить().Выгрузить();
	ОстаткиПоНоменклатуре = Новый Соответствие;
	
	Для Каждого СтрокаТаблицы Из Таблица Цикл
		ОстаткиПоНоменклатуре.Вставить(СтрокаТаблицы.Номенклатура, СтрокаТаблицы.Остаток);
	КонецЦикла;
	
	Возврат ОстаткиПоНоменклатуре;
	
КонецФункции


// --- HTTP ---
Функция ОтправитьHTTP(JSONСтрока) Экспорт
	
	// Поддержка варианта ?token=
	ПолныйПуть = ПутьAPI;
	Если НЕ ПустаяСтрока(ТокенДоступа) Тогда
		Если Найти(НижРег(ПолныйПуть), "token=") = 0 Тогда
			Если Найти(ПолныйПуть, "?") = 0 Тогда
				ПолныйПуть = ПолныйПуть + "?token=" + ТокенДоступа;
			Иначе
				ПолныйПуть = ПолныйПуть + "&token=" + ТокенДоступа;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Соединение = Новый HTTPСоединение(АдресСервера);
	ЗапросHTTP = Новый HTTPЗапрос(ПолныйПуть);
	ЗапросHTTP.УстановитьТелоИзСтроки(JSONСтрока, КодировкаТекста.UTF8);
	ЗапросHTTP.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
	// Токен в заголовке (если задан)
	Если НЕ ПустаяСтрока(ТокенДоступа) Тогда
		ЗапросHTTP.Заголовки.Вставить("Authorization", "Bearer " + ТокенДоступа);
		ЗапросHTTP.Заголовки.Вставить("X-1C-Token", ТокенДоступа);
		ЗапросHTTP.Заголовки.Вставить("X-Token", ТокенДоступа);
	КонецЕсли;
	
	ОтветHTTP = Соединение.Выполнить(ЗапросHTTP);
	
	Код = ОтветHTTP.КодСостояния;
	Тело = ОтветHTTP.ПолучитьТелоКакСтроку();
	
	Если ВестиЛог Тогда
		ЗаписатьЛог("Код ответа: " + Код);
		ЗаписатьЛог("Тело ответа: " + Тело);
	КонецЕсли;
	
	Возврат "Код=" + Код + "; Тело=" + Тело;
	
КонецФункции


// --- Логирование ---
Процедура ЗаписатьЛог(ТекстСообщения) Экспорт
	
	Попытка
		Путь = КаталогВременныхФайлов();
		Если НЕ ПустаяСтрока(ТекущийКаталог()) Тогда
			Путь = ТекущийКаталог();
		КонецЕсли;
		
		ИмяФайла = Путь + "catalog_push_log.txt";
		ТекстовыйФайл = Новый ТекстовыйДокумент;
		Если ФайлСуществует(ИмяФайла) Тогда
			ТекстовыйФайл.Прочитать(ИмяФайла);
		КонецЕсли;
		ТекстовыйФайл.ДобавитьСтроку(Формат(ТекущаяДата(), "ДЛФ=DT") + " | " + ТекстСообщения);
		ТекстовыйФайл.Записать(ИмяФайла);
	Исключение
		// Логирование не должно ломать обработку
	КонецПопытки;
	
КонецПроцедуры
```

---

## Модуль формы (если используете форму с кнопкой «Выгрузить»)

> Скопируйте целиком в модуль формы обработки.

```bsl
// === МОДУЛЬ ФОРМЫ ===

Процедура ВыгрузитьНажатие(Кнопка)
	Объект.ВыгрузитьКаталог();
КонецПроцедуры
```

---

## Пошаговая инструкция (УТ 10.3)

1) **Создайте внешнюю обработку**  
   - В конфигураторе создайте новый файл внешней обработки (.epf) либо в режиме Предприятие откройте существующий файл.  
   - Откройте **Файл → Открыть** и выберите созданный .epf (для проверки запуска).

2) **Вставьте код модуля обработки**  
   - Откройте модуль обработки и вставьте код из раздела **«Модуль обработки»**.

3) **(Опционально) Создайте форму с кнопкой**  
   - Добавьте форму обработки с кнопкой «Выгрузить».  
   - В модуль формы вставьте код из раздела **«Модуль формы»**.

4) **Запуск**  
   - В режиме Предприятие: **Файл → Открыть**, выберите ваш .epf.  
   - Нажмите кнопку «Выгрузить» (если форма есть).  
   - Либо выполните обработку напрямую (если используете автозапуск/команды).

5) **Введите параметры**  
   - Адрес сервера (например `https://example.com`)  
   - Путь API (например `/integrations/1c/catalog`, `/onec/catalog` или `/api/onec/catalog`)  
   - Токен (опционально)  
   - Тип цен (например `Розничная` или `Розница`)  
   - Дата выгрузки (по умолчанию текущая)

6) **Проверка ответа**  
   - В окне сообщений появится код ответа и тело ответа.  
   - Если включён лог — файл `catalog_push_log.txt` создаётся рядом с .epf (или во временной папке).

