<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Debug: поиск как клиент</title>
</head>
<body>
  <h1>Debug: поиск как клиент</h1>

  <h2>Контекст</h2>
  <form action="/admin/debug/search-as" method="post">
    <label>
      Org ID:
      <input type="text" name="org_id" value="{{ org_id }}" placeholder="123" />
    </label>
    <span>или</span>
    <label>
      Телефон пользователя:
      <input type="text" name="phone" value="{{ phone }}" placeholder="+7999..." />
    </label>
    <button type="submit">Выбрать контекст</button>
  </form>

  {% if selected_user %}
    <p>Пользователь: #{{ selected_user.id }} — {{ selected_user.fio }}</p>
  {% endif %}
  {% if selected_org %}
    <p>Организация: #{{ selected_org.id }} — {{ selected_org.name }}</p>
  {% endif %}

  {% if error %}
    <p style="color: red;">{{ error }}</p>
  {% endif %}

  <h2>Одиночный запрос</h2>
  <form action="/admin/debug/search-as" method="post">
    <input type="hidden" name="org_id" value="{{ org_id }}" />
    <input type="hidden" name="phone" value="{{ phone }}" />
    <input type="hidden" name="offset" value="{{ offset or 0 }}" />
    <input type="text" name="query" value="{{ query }}" placeholder="Введите запрос" size="60" />
    <button type="submit">Проверить</button>
  </form>

  <h2>Пакетная проверка</h2>
  <form action="/admin/debug/search-as" method="post">
    <input type="hidden" name="org_id" value="{{ org_id }}" />
    <input type="hidden" name="phone" value="{{ phone }}" />
    <input type="hidden" name="offset" value="{{ offset or 0 }}" />
    <textarea name="batch" rows="6" cols="80" placeholder="Каждый запрос на новой строке">{{ batch }}</textarea>
    <br />
    <button type="submit">Проверить пакет</button>
  </form>


  {% if decision and decision.multi_item and trace %}
    <h2>Результаты по позициям</h2>
    {% set items = trace.items if trace and trace.items else [] %}
    {% for entry in items %}
      <details open>
        <summary>Позиция {{ loop.index }} — {{ entry.query_core }} (qty={{ entry.item.qty }}, unit={{ entry.item.unit }})</summary>
        <p>Decision: {{ entry.decision.decision if entry.decision else "" }}</p>
        <ul>
          {% for item in entry.results %}
            <li>{{ item.title_ru }} (SKU: {{ item.sku }})</li>
          {% endfor %}
        </ul>
        {% if entry.trace %}
          <pre>{{ entry.trace | tojson(indent=2) }}</pre>
        {% endif %}
      </details>
    {% endfor %}
  {% endif %}

  {% if results %}
    <h2>Результаты</h2>
    <ul>
      {% for item in results %}
        <li>{{ item.title_ru }} (SKU: {{ item.sku }}) [category_id={{ item.category_id or "" }}]</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if decision %}
    <h3>Decision payload</h3>
    <pre>{{ decision | tojson(indent=2) }}</pre>
    {% if decision.decision == "needs_clarification" and decision.clarification %}
      <h3>Clarification</h3>
      <p><strong>{{ decision.clarification.question }}</strong> (reason: {{ decision.clarification.reason }})</p>
      <ul>
        {% for option in decision.clarification.options %}
          <li>{{ option.label }} — <code>{{ option.apply | tojson }}</code></li>
        {% endfor %}
      </ul>
      <p>Показано {{ decision.clarification.options|length }} из {{ decision.clarification.total }} (offset={{ decision.clarification.offset }})</p>
      <div>
        {% if decision.clarification.prev_offset is not none %}
          <form action="/admin/debug/search-as" method="post" style="display:inline-block;">
            <input type="hidden" name="org_id" value="{{ org_id }}" />
            <input type="hidden" name="phone" value="{{ phone }}" />
            <input type="hidden" name="query" value="{{ query }}" />
            <input type="hidden" name="offset" value="{{ decision.clarification.prev_offset }}" />
            <button type="submit">⬅️ Prev</button>
          </form>
        {% endif %}
        {% if decision.clarification.next_offset is not none %}
          <form action="/admin/debug/search-as" method="post" style="display:inline-block; margin-left:8px;">
            <input type="hidden" name="org_id" value="{{ org_id }}" />
            <input type="hidden" name="phone" value="{{ phone }}" />
            <input type="hidden" name="query" value="{{ query }}" />
            <input type="hidden" name="offset" value="{{ decision.clarification.next_offset }}" />
            <button type="submit">Next ➡️</button>
          </form>
        {% endif %}
      </div>

    {% endif %}
    <h3>Stages</h3>
    <ul>
      <li>history_used: {{ decision.history_used }}</li>
      <li>alias_used: {{ decision.alias_used }}</li>
      <li>decision: {{ decision.decision }}</li>
      <li>llm_narrow_confidence: {{ decision.llm_narrow_confidence }}</li>
      <li>rerank_used: {{ decision.rerank_used }}</li>
      <li>synonym_retry_attempted: {{ decision.synonym_retry_attempted }}</li>
      <li>query_retry: {{ decision.query_retry }}</li>
      <li>retry_results_count: {{ decision.retry_results_count }}</li>
      <li>query_facets: {{ decision.query_facets }}</li>
      <li>applied_filters: {{ decision.applied_filters }}</li>
    </ul>
  {% endif %}

  {% if trace %}
    <h3>Trace</h3>
    <details open>
      <summary>Input</summary>
      <pre>{{ trace.input | tojson(indent=2) }}</pre>
    </details>
    {% for stage in trace.stages %}
      {% if stage %}
        <details>
          <summary>{{ stage.name }} — {{ stage.notes }}</summary>
          <ul>
            <li>query_used: <code>{{ stage.query_used }}</code></li>
            <li>tokens_used: {{ stage.tokens_used }}</li>
            <li>numbers_used: {{ stage.numbers_used }}</li>
            <li>product_ids_filter_count: {{ stage.product_ids_filter_count if stage.product_ids_filter_count is not none else "" }}</li>
            <li>category_ids_filter: {{ stage.category_ids_filter }}</li>
            <li>candidates_before: {{ stage.candidates_before }}</li>
            <li>candidates_after: {{ stage.candidates_after }}</li>
            <li>top5_titles: {{ stage.top5_titles }}</li>
            {% if stage.attempts %}
              <li>history_total_available: {{ stage.history_total_available }}</li>
              <li>limit_used: {{ stage.limit_used }}</li>
              <li>attempt_query_used: {{ stage.attempt_query_used }}</li>
              <li>history_used: {{ stage.history_used }}</li>
              <li>top_titles: {{ stage.top_titles }}</li>
              <li>
                attempts:
                <ul>
                  {% for a in stage.attempts %}
                    <li>query_used={{ a.query_used }}, limit_used={{ a.limit_used }}, candidates_count={{ a.candidates_count }}, candidates_found={{ a.candidates_found }}, note={{ a.note }}</li>
                  {% endfor %}
                </ul>
              </li>
            {% endif %}
          </ul>
        </details>
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if batch_results %}
    <h2>Batch результаты</h2>
    <table border="1" cellpadding="6">
      <tr>
        <th>Query</th>
        <th>Decision</th>
        <th>Candidates</th>
        <th>Top1</th>
      </tr>
      {% for entry in batch_results %}
        <tr>
          <td>{{ entry.query }}</td>
          <td>{{ entry.decision.decision }}</td>
          <td>{{ entry.decision.candidates_count_final }}</td>
          <td>{{ entry.results[0].title_ru if entry.results else "" }}</td>
        </tr>
        {% if entry.trace %}
          <tr>
            <td colspan="4">
              <details>
                <summary>Trace: {{ entry.query }}</summary>
                <pre>{{ entry.trace | tojson(indent=2) }}</pre>
              </details>
            </td>
          </tr>
        {% endif %}
      {% endfor %}
    </table>
  {% endif %}

  <a href="/admin">Назад</a>
</body>
</html>
